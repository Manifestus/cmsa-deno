// ---------- Generators / Datasource ----------
generator client {
  provider = "prisma-client"
  runtime  = "deno"
  output   = "./src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------- Enums ----------
enum Sex {
  M
  F
  Other
  Unknown
}

enum MaritalStatus {
  single
  married
  divorced
  widowed
  other
}

enum WorkstationType {
  frontdesk
  cashier
  admin
  lab
  ultrasound
  doctor_office
}

enum InvoiceStatus {
  draft
  posted
  void
}

enum ItemType {
  service
  product
}

enum PaymentMethod {
  cash
  card
  transfer
  other
}

enum TransferStatus {
  not_completed
  completed
}

enum CashMovementType {
  sale
  withdrawal
  deposit
  adjustment
}

enum StockReason {
  purchase
  sale
  adjustment
  loss
  return
}

enum AllergySeverity {
  mild
  moderate
  severe
  unknown
}

enum ProblemStatus {
  active
  resolved
  remission
  unknown
}

enum Route {
  oral
  iv
  im
  sc
  topical
  other
}

enum Priority {
  routine
  urgent
  stat
}

enum LabOrderStatus {
  pending
  in_progress
  completed
  canceled
  partial
}

enum LabOrderTestStatus {
  pending
  in_progress
  completed
  canceled
}

enum AbnormalFlag {
  H
  L
  N
  A // alert/abnormal other
}

enum OutOfRangeFlag {
  low
  high
}

enum ConnectionType {
  serial
  tcp
  file
  other
}

enum ProtocolKind {
  HL7
  ASTM
  CSV
  TXT
  JSON
  Other
}

// (optional, but useful for withdrawals classification)
enum ExpenseType {
  purchase
  bank_deposit
  other
}

// ---------- Bootstrap (unchanged) ----------
model bootstrap {
  id  String @id @default(uuid()) @db.Uuid
  txt String
}

// ---------- RBAC ----------
model Role {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @db.VarChar(60)
  description String? @db.VarChar(200)

  users UserRole[]

  @@unique([name])
  @@map("roles")
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  username  String   @unique @db.VarChar(80)
  fullName  String   @db.VarChar(120)
  email     String   @unique @db.VarChar(160)
  phone     String?  @db.VarChar(30)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  roles              UserRole[]
  sessions           AuthSession[]
  patientsCreated    Patient[]      @relation("PatientCreatedBy")
  preclinics         Preclinic[]    @relation("PreclinicRecordedBy")
  problemsRecorded   Problem[]      @relation("ProblemRecordedBy")
  allergiesRecorded  Allergy[]      @relation("AllergyRecordedBy")
  medicationsRx      Medication[]   @relation("MedicationPrescribedBy")
  invoicesCashier    Invoice[]      @relation("InvoiceCashier")
  paymentsCreated    Payment[]      @relation("PaymentCreatedBy")
  cashSessionsOpen   CashSession[]  @relation("CashSessionOpenedBy")
  cashSessionsClose  CashSession[]  @relation("CashSessionClosedBy")
  cashMovements      CashMovement[] @relation("CashMovementCreatedBy")
  labOrdersOrdered   LabOrder[]     @relation("OrderingProvider")
  labOrdersCollected LabOrder[]     @relation("CollectedBy")
  activity           ActivityLog[]  @relation("ActivityActor")

  @@map("users")
}

model UserRole {
  userId String @db.Uuid
  roleId String @db.Uuid

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

// ---------- Locations / POS infra ----------
model Location {
  id      String  @id @default(uuid()) @db.Uuid
  name    String  @db.VarChar(120)
  address String? @db.VarChar(200)

  registers      CashRegister[]
  posTerminals   PosTerminal[]
  workstations   Workstation[]
  productStock   ProductStock[]
  stockMoves     StockMovement[]
  labInstruments LabInstrument[]

  invoices Invoice[]

  @@unique([name]) // allow upsert/find by name
  @@map("locations")
}

model CashRegister {
  id         String   @id @default(uuid()) @db.Uuid
  name       String   @db.VarChar(80)
  locationId String   @db.Uuid
  location   Location @relation(fields: [locationId], references: [id])

  sessions CashSession[]
  invoices Invoice[]

  @@unique([name])
  @@map("cash_registers")
}

model PosTerminal {
  id         String   @id @default(uuid()) @db.Uuid
  name       String   @db.VarChar(80)
  provider   String   @db.VarChar(80)
  merchantId String?  @db.VarChar(80)
  locationId String   @db.Uuid
  location   Location @relation(fields: [locationId], references: [id])

  payments Payment[]

  @@unique([name])
  @@map("pos_terminals")
}

model Workstation {
  id            String          @id @default(uuid()) @db.Uuid
  name          String          @db.VarChar(80)
  locationId    String          @db.Uuid
  location      Location        @relation(fields: [locationId], references: [id])
  type          WorkstationType
  macAddress    String?         @db.VarChar(40)
  allowedIpCidr String?         @db.VarChar(64)
  isActive      Boolean         @default(true)

  sessions AuthSession[]
  contexts RequestContext[]

  @@unique([name])
  @@map("workstations")
}

// ---------- Patients ----------
model Patient {
  id                    String         @id @default(uuid()) @db.Uuid
  mrn                   String         @db.VarChar(40)
  nationalId            String?        @db.VarChar(40)
  firstName             String         @db.VarChar(80)
  lastName              String         @db.VarChar(80)
  dob                   DateTime?      @db.Date
  sex                   Sex?
  maritalStatus         MaritalStatus?
  phone                 String?        @db.VarChar(30)
  email                 String?        @db.VarChar(160)
  address               String?        @db.VarChar(200)
  city                  String?        @db.VarChar(80)
  region                String?        @db.VarChar(80)
  country               String?        @db.VarChar(2)
  bloodType             String?        @db.VarChar(3)
  emergencyContactName  String?        @db.VarChar(120)
  emergencyContactPhone String?        @db.VarChar(30)
  createdById           String?        @db.Uuid
  createdBy             User?          @relation("PatientCreatedBy", fields: [createdById], references: [id])
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  preclinics  Preclinic[]
  allergies   Allergy[]
  problems    Problem[]
  medications Medication[]
  invoices    Invoice[]
  labOrders   LabOrder[]

  @@unique([mrn])
  @@map("patients")
}

// ---------- Security / Sessions ----------
model AuthSession {
  id                String       @id @default(uuid()) @db.Uuid
  userId            String       @db.Uuid
  user              User         @relation(fields: [userId], references: [id])
  startedAt         DateTime     @default(now())
  endedAt           DateTime?
  ipAddress         String       @db.VarChar(45)
  userAgent         String       @db.VarChar(255)
  deviceFingerprint String?      @db.VarChar(120)
  workstationId     String?      @db.Uuid
  workstation       Workstation? @relation(fields: [workstationId], references: [id])
  geoCountry        String?      @db.VarChar(2)
  geoRegion         String?      @db.VarChar(80)
  geoCity           String?      @db.VarChar(80)
  geoLat            Decimal?     @db.Decimal(9, 6)
  geoLon            Decimal?     @db.Decimal(9, 6)
  mfaPassed         Boolean      @default(false)

  contexts RequestContext[]

  @@map("auth_sessions")
}

model RequestContext {
  id                String       @id @default(uuid()) @db.Uuid
  sessionId         String       @db.Uuid
  session           AuthSession  @relation(fields: [sessionId], references: [id])
  occurredAt        DateTime     @default(now())
  ipAddress         String       @db.VarChar(45)
  userAgent         String       @db.VarChar(255)
  deviceFingerprint String?      @db.VarChar(120)
  workstationId     String?      @db.Uuid
  workstation       Workstation? @relation(fields: [workstationId], references: [id])
  geoCountry        String?      @db.VarChar(2)
  geoRegion         String?      @db.VarChar(80)
  geoCity           String?      @db.VarChar(80)
  geoLat            Decimal?     @db.Decimal(9, 6)
  geoLon            Decimal?     @db.Decimal(9, 6)

  invoices      Invoice[]      @relation("InvoiceRC")
  payments      Payment[]      @relation("PaymentRC")
  cashMoves     CashMovement[] @relation("CashMovementRC")
  preclinics    Preclinic[]
  labOrders     LabOrder[]
  labOrderTests LabOrderTest[]
  activities    ActivityLog[]

  cashSessionsOpened CashSession[] @relation("CashSessionOpenRC")
  cashSessionsClosed CashSession[] @relation("CashSessionCloseRC")

  @@map("request_contexts")
}

// ---------- Preclinic / Structured clinical ----------
model Preclinic {
  id                     String         @id @default(uuid()) @db.Uuid
  patientId              String         @db.Uuid
  patient                Patient        @relation(fields: [patientId], references: [id])
  visitDate              DateTime
  bloodPressureSystolic  Int?
  bloodPressureDiastolic Int?
  heartRate              Int?
  respRate               Int?
  temperatureC           Decimal?       @db.Decimal(4, 1)
  weightKg               Decimal?       @db.Decimal(6, 2)
  heightCm               Decimal?       @db.Decimal(5, 2)
  bmi                    Decimal?       @db.Decimal(5, 2)
  chiefComplaint         String?        @db.VarChar(250)
  currentMedications     String?        @db.VarChar(250)
  labOrders              LabOrder[]     @relation("PreclinicLabOrders")
  diabetes               Boolean?
  hypertension           Boolean?
  otherConditions        String?        @db.VarChar(250)
  allergiesReported      String?        @db.VarChar(250)
  recordedById           String         @db.Uuid
  recordedBy             User           @relation("PreclinicRecordedBy", fields: [recordedById], references: [id])
  requestContextId       String         @db.Uuid
  requestContext         RequestContext @relation(fields: [requestContextId], references: [id])

  invoices Invoice[]

  @@map("preclinic")
}

model Allergy {
  id           String           @id @default(uuid()) @db.Uuid
  patientId    String           @db.Uuid
  patient      Patient          @relation(fields: [patientId], references: [id])
  substance    String           @db.VarChar(120)
  reaction     String?          @db.VarChar(160)
  severity     AllergySeverity?
  recordedAt   DateTime         @default(now())
  recordedById String?          @db.Uuid
  recordedBy   User?            @relation("AllergyRecordedBy", fields: [recordedById], references: [id])

  @@map("allergies")
}

model Problem {
  id           String        @id @default(uuid()) @db.Uuid
  patientId    String        @db.Uuid
  patient      Patient       @relation(fields: [patientId], references: [id])
  condition    String        @db.VarChar(160)
  status       ProblemStatus
  diagnosedAt  DateTime?     @db.Date
  resolvedAt   DateTime?     @db.Date
  recordedById String?       @db.Uuid
  recordedBy   User?         @relation("ProblemRecordedBy", fields: [recordedById], references: [id])

  @@map("problems")
}

model Medication {
  id             String    @id @default(uuid()) @db.Uuid
  patientId      String    @db.Uuid
  patient        Patient   @relation(fields: [patientId], references: [id])
  drugName       String    @db.VarChar(160)
  dose           String?   @db.VarChar(60)
  frequency      String?   @db.VarChar(60)
  route          Route?
  startedAt      DateTime? @db.Date
  stoppedAt      DateTime? @db.Date
  prescribedById String?   @db.Uuid
  prescribedBy   User?     @relation("MedicationPrescribedBy", fields: [prescribedById], references: [id])

  @@map("medications")
}

// ---------- Services / POS ----------
model ServiceCategory {
  id   String @id @default(uuid()) @db.Uuid
  name String @db.VarChar(80)

  services Service[]

  @@map("service_categories")
}

model Service {
  id               String          @id @default(uuid()) @db.Uuid
  code             String          @db.VarChar(40)
  name             String          @db.VarChar(120)
  categoryId       String          @db.Uuid
  category         ServiceCategory @relation(fields: [categoryId], references: [id])
  price            Decimal         @db.Decimal(12, 2)
  taxRatePct       Decimal         @db.Decimal(5, 2)
  commissionPct    Decimal?        @db.Decimal(5, 2)
  requiresProvider Boolean         @default(false)

  lines InvoiceLine[]

  @@unique([code])
  @@map("services")
}

model Provider {
  id                   String   @id @default(uuid()) @db.Uuid
  fullName             String   @db.VarChar(120)
  specialty            String?  @db.VarChar(80)
  defaultCommissionPct Decimal? @db.Decimal(5, 2)
  isActive             Boolean  @default(true)

  lines       InvoiceLine[]
  commissions ProviderCommission[]

  @@unique([fullName])
  @@map("providers")
}

model Invoice {
  id          String        @id @default(uuid()) @db.Uuid
  invoiceNo   String        @db.VarChar(30)
  patientId   String?       @db.Uuid
  patient     Patient?      @relation(fields: [patientId], references: [id])
  preclinicId String?       @db.Uuid
  preclinic   Preclinic?    @relation(fields: [preclinicId], references: [id])
  status      InvoiceStatus
  invoiceAt   DateTime
  locationId  String        @db.Uuid
  location    Location      @relation(fields: [locationId], references: [id])
  cashierId   String        @db.Uuid
  cashier     User          @relation("InvoiceCashier", fields: [cashierId], references: [id])
  registerId  String?       @db.Uuid
  register    CashRegister? @relation(fields: [registerId], references: [id])

  // ðŸ”¥ new: bind invoice to a cash session
  cashSessionId String?      @db.Uuid
  cashSession   CashSession? @relation(fields: [cashSessionId], references: [id])

  requestContextId String         @db.Uuid
  requestContext   RequestContext @relation("InvoiceRC", fields: [requestContextId], references: [id])
  subtotal         Decimal        @db.Decimal(12, 2)
  discountTotal    Decimal        @db.Decimal(12, 2)
  taxTotal         Decimal        @db.Decimal(12, 2)
  total            Decimal        @db.Decimal(12, 2)

  lines     InvoiceLine[]
  payments  Payment[]
  labOrders LabOrder[]

  @@unique([invoiceNo, locationId])
  @@map("invoices")
}

model InvoiceLine {
  id          String            @id @default(uuid()) @db.Uuid
  invoiceId   String            @db.Uuid
  invoice     Invoice           @relation(fields: [invoiceId], references: [id])
  lineNo      Int
  itemType    ItemType
  serviceId   String?           @db.Uuid
  service     Service?          @relation(fields: [serviceId], references: [id])
  productId   String?           @db.Uuid
  product     InventoryProduct? @relation(fields: [productId], references: [id])
  description String            @db.VarChar(200)
  qty         Decimal           @db.Decimal(10, 2)
  unitPrice   Decimal           @db.Decimal(12, 2)
  discountPct Decimal           @db.Decimal(5, 2)
  taxRatePct  Decimal           @db.Decimal(5, 2)
  lineTotal   Decimal           @db.Decimal(12, 2)
  providerId  String?           @db.Uuid
  provider    Provider?         @relation(fields: [providerId], references: [id])

  commission ProviderCommission? @relation("InvoiceLineCommission")

  @@index([invoiceId])
  @@map("invoice_lines")
}

model ProviderCommission {
  id               String      @id @default(uuid()) @db.Uuid
  invoiceLineId    String      @unique @db.Uuid
  invoiceLine      InvoiceLine @relation("InvoiceLineCommission", fields: [invoiceLineId], references: [id])
  providerId       String      @db.Uuid
  provider         Provider    @relation(fields: [providerId], references: [id])
  baseAmount       Decimal     @db.Decimal(12, 2)
  ratePct          Decimal     @db.Decimal(5, 2)
  commissionAmount Decimal     @db.Decimal(12, 2)
  isPaid           Boolean     @default(false)

  @@map("provider_commissions")
}

model Payment {
  id               String          @id @default(uuid()) @db.Uuid
  invoiceId        String          @db.Uuid
  invoice          Invoice         @relation(fields: [invoiceId], references: [id])
  method           PaymentMethod
  transferStatus   TransferStatus?
  amount           Decimal         @db.Decimal(12, 2)
  currency         String          @db.Char(3)
  exchangeRate     Decimal?        @db.Decimal(12, 6)
  reference        String?         @db.VarChar(120)
  posTerminalId    String?         @db.Uuid
  posTerminal      PosTerminal?    @relation(fields: [posTerminalId], references: [id])
  createdById      String          @db.Uuid
  createdBy        User            @relation("PaymentCreatedBy", fields: [createdById], references: [id])
  requestContextId String          @db.Uuid
  requestContext   RequestContext  @relation("PaymentRC", fields: [requestContextId], references: [id])
  createdAt        DateTime        @default(now())

  @@index([invoiceId])
  @@map("payments")
}

model CashSession {
  id            String       @id @default(uuid()) @db.Uuid
  registerId    String       @db.Uuid
  register      CashRegister @relation(fields: [registerId], references: [id])
  openedById    String       @db.Uuid
  openedBy      User         @relation("CashSessionOpenedBy", fields: [openedById], references: [id])
  openedAt      DateTime     @default(now())
  openingFloat  Decimal      @db.Decimal(12, 2)
  closedById    String?      @db.Uuid
  closedBy      User?        @relation("CashSessionClosedBy", fields: [closedById], references: [id])
  closedAt      DateTime?
  declaredTotal Decimal?     @db.Decimal(12, 2)
  systemTotal   Decimal?     @db.Decimal(12, 2)
  variance      Decimal?     @db.Decimal(12, 2)

  movements CashMovement[]
  invoices  Invoice[]

  requestContextId String         @db.Uuid
  requestContext   RequestContext @relation("CashSessionOpenRC", fields: [requestContextId], references: [id])

  closedRequestContextId String?         @db.Uuid
  closedRequestContext   RequestContext? @relation("CashSessionCloseRC", fields: [closedRequestContextId], references: [id])

  @@map("cash_sessions")
}

model CashMovement {
  id        String           @id @default(uuid()) @db.Uuid
  sessionId String           @db.Uuid
  session   CashSession      @relation(fields: [sessionId], references: [id])
  type      CashMovementType
  amount    Decimal          @db.Decimal(12, 2)
  reference String?          @db.VarChar(120)

  expenseType ExpenseType? // ðŸ”¸ optional classification for withdrawals

  createdById      String         @db.Uuid
  createdBy        User           @relation("CashMovementCreatedBy", fields: [createdById], references: [id])
  requestContextId String         @db.Uuid
  requestContext   RequestContext @relation("CashMovementRC", fields: [requestContextId], references: [id])
  createdAt        DateTime       @default(now())

  @@map("cash_movements")
}

// ---------- Inventory ----------
model InventoryProduct {
  id         String  @id @default(uuid()) @db.Uuid
  sku        String  @db.VarChar(60)
  name       String  @db.VarChar(120)
  unit       String? @db.VarChar(20)
  price      Decimal @db.Decimal(12, 2)
  taxRatePct Decimal @db.Decimal(5, 2)
  isActive   Boolean @default(true)

  stock      ProductStock[]
  stockMoves StockMovement[]
  lines      InvoiceLine[]

  @@unique([sku])
  @@map("inventory_products")
}

model ProductStock {
  id         String           @id @default(uuid()) @db.Uuid
  productId  String           @db.Uuid
  product    InventoryProduct @relation(fields: [productId], references: [id])
  locationId String           @db.Uuid
  location   Location         @relation(fields: [locationId], references: [id])
  onHand     Int

  @@unique([productId, locationId])
  @@map("product_stock")
}

model StockMovement {
  id         String           @id @default(uuid()) @db.Uuid
  productId  String           @db.Uuid
  product    InventoryProduct @relation(fields: [productId], references: [id])
  locationId String           @db.Uuid
  location   Location         @relation(fields: [locationId], references: [id])
  qty        Int
  reason     StockReason
  reference  String?          @db.VarChar(120)
  createdAt  DateTime         @default(now())

  @@map("stock_movements")
}

// ---------- Lab: instruments & catalog ----------
model LabInstrument {
  id             String          @id @default(uuid()) @db.Uuid
  name           String          @db.VarChar(120)
  vendor         String?         @db.VarChar(80)
  model          String?         @db.VarChar(80)
  serialNo       String?         @db.VarChar(80)
  connectionType ConnectionType?
  locationId     String?         @db.Uuid
  location       Location?       @relation(fields: [locationId], references: [id])
  isActive       Boolean         @default(true)

  testsDefault TestCatalog[]      @relation("DefaultInstrument")
  orderTests   LabOrderTest[]
  messages     LabDeviceMessage[]

  @@map("lab_instruments")
}

model SpecimenType {
  id   String @id @default(uuid()) @db.Uuid
  name String @db.VarChar(60)

  tests  TestCatalog[]
  orders LabOrder[]

  @@unique([name])
  @@map("specimen_types")
}

model TestCatalog {
  id                  String         @id @default(uuid()) @db.Uuid
  code                String         @db.VarChar(40)
  name                String         @db.VarChar(160)
  loincCode           String?        @db.VarChar(40)
  units               String?        @db.VarChar(40)
  specimenTypeId      String?        @db.Uuid
  specimenType        SpecimenType?  @relation(fields: [specimenTypeId], references: [id])
  defaultInstrumentId String?        @db.Uuid
  defaultInstrument   LabInstrument? @relation("DefaultInstrument", fields: [defaultInstrumentId], references: [id])
  isPanel             Boolean        @default(false)
  parentPanelId       String?        @db.Uuid
  parentPanel         TestCatalog?   @relation("PanelMembers", fields: [parentPanelId], references: [id])
  panelMembers        TestCatalog[]  @relation("PanelMembers")

  ranges     ReferenceRange[]
  orderTests LabOrderTest[]

  @@unique([code])
  @@map("test_catalog")
}

model ReferenceRange {
  id          String      @id @default(uuid()) @db.Uuid
  testId      String      @db.Uuid
  test        TestCatalog @relation(fields: [testId], references: [id])
  sex         Sex?
  ageMinYears Decimal?    @db.Decimal(5, 2)
  ageMaxYears Decimal?    @db.Decimal(5, 2)
  lowValue    Decimal?    @db.Decimal(12, 4)
  highValue   Decimal?    @db.Decimal(12, 4)
  notes       String?     @db.VarChar(200)

  @@map("reference_ranges")
}

// ---------- Lab: orders & results ----------
model LabOrder {
  id                 String         @id @default(uuid()) @db.Uuid
  accessionNo        String         @db.VarChar(40)
  patientId          String         @db.Uuid
  patient            Patient        @relation(fields: [patientId], references: [id])
  orderingProviderId String?        @db.Uuid
  orderingProvider   User?          @relation("OrderingProvider", fields: [orderingProviderId], references: [id])
  invoiceId          String?        @db.Uuid
  invoice            Invoice?       @relation(fields: [invoiceId], references: [id])
  preclinicId        String?        @db.Uuid
  preclinic          Preclinic?     @relation("PreclinicLabOrders", fields: [preclinicId], references: [id])
  specimenTypeId     String?        @db.Uuid
  specimenType       SpecimenType?  @relation(fields: [specimenTypeId], references: [id])
  collectionTime     DateTime?
  collectedById      String?        @db.Uuid
  collectedBy        User?          @relation("CollectedBy", fields: [collectedById], references: [id])
  priority           Priority?
  status             LabOrderStatus
  notes              String?        @db.VarChar(250)
  requestContextId   String         @db.Uuid
  requestContext     RequestContext @relation(fields: [requestContextId], references: [id])

  tests    LabOrderTest[]
  messages LabDeviceMessage[]

  @@unique([accessionNo])
  @@map("lab_orders")
}

model LabOrderTest {
  id                    String             @id @default(uuid()) @db.Uuid
  orderId               String             @db.Uuid
  order                 LabOrder           @relation(fields: [orderId], references: [id])
  testId                String             @db.Uuid
  test                  TestCatalog        @relation(fields: [testId], references: [id])
  status                LabOrderTestStatus
  instrumentId          String?            @db.Uuid
  instrument            LabInstrument?     @relation(fields: [instrumentId], references: [id])
  analyteCodeInstrument String?            @db.VarChar(60)

  // results
  resultValue   Decimal?        @db.Decimal(16, 6)
  resultText    String?         @db.VarChar(160)
  units         String?         @db.VarChar(40)
  flagAbnormal  AbnormalFlag?
  outOfRange    OutOfRangeFlag?
  referenceLow  Decimal?        @db.Decimal(16, 6)
  referenceHigh Decimal?        @db.Decimal(16, 6)
  completedAt   DateTime?
  resultNotes   String?         @db.VarChar(250)

  requestContextId String         @db.Uuid
  requestContext   RequestContext @relation(fields: [requestContextId], references: [id])

  @@index([orderId, testId])
  @@map("lab_order_tests")
}

model LabDeviceMessage {
  id           String        @id @default(uuid()) @db.Uuid
  instrumentId String        @db.Uuid
  instrument   LabInstrument @relation(fields: [instrumentId], references: [id])
  orderId      String?       @db.Uuid
  order        LabOrder?     @relation(fields: [orderId], references: [id])
  receivedAt   DateTime      @default(now())
  protocol     ProtocolKind?
  rawContent   String        @db.Text
  parsedOk     Boolean       @default(false)

  @@index([instrumentId, receivedAt])
  @@map("lab_device_messages")
}

// ---------- Audit ----------
model ActivityLog {
  id               String         @id @default(uuid()) @db.Uuid
  entity           String         @db.VarChar(60)
  entityId         String         @db.Uuid
  action           String         @db.VarChar(30) // create/update/delete/print/refund/close_register
  actorId          String         @db.Uuid
  actor            User           @relation("ActivityActor", fields: [actorId], references: [id])
  requestContextId String         @db.Uuid
  requestContext   RequestContext @relation(fields: [requestContextId], references: [id])
  metadata         Json?          @db.JsonB
  createdAt        DateTime       @default(now())

  @@index([entity, action, createdAt])
  @@map("activity_log")
}
